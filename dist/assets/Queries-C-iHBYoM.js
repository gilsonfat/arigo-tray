import{j as e,r,a as T}from"./index-JjGluSb1.js";import{f as A,g as D,h as M,i as z}from"./index-BPE1NJCr.js";import{a as I,A as Q,B as C,e as P,f as R,M as $,C as B,h as J,i as H,j as V,k as W}from"./ConfirmDialog-CWlH6QHb.js";const Y=({columns:d=[],data:j=[],emptyMessage:_="Nenhum dado encontrado",hoverable:a=!1,className:b=""})=>j.length?e.jsx("div",{className:`overflow-x-auto ${b}`,children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:d.map((n,y)=>e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:n.label||n.key},n.key||y))})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:j.map((n,y)=>e.jsx("tr",{className:a?"hover:bg-gray-50":"",children:d.map((m,x)=>e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:m.render?m.render(n):n[m.key]!==void 0?String(n[m.key]):"-"},`${y}-${m.key||x}`))},n.id||y))})]})}):e.jsx("div",{className:"bg-gray-50 border rounded p-8 text-center text-gray-500",children:_}),G=({query:d,onSave:j,onCancel:_})=>{const[a,b]=r.useState({nome:"",descricao:"",query:"",conexao_id:"",formato_saida:"json",transform_type:"",...d||{}});r.useEffect(()=>{d&&d.sql&&!a.query&&b(o=>({...o,query:d.sql}))},[d]);const[n,y]=r.useState([]),[m,x]=r.useState(!0),[p,k]=r.useState(!1),[t,u]=r.useState(null),[E,h]=r.useState(""),i=r.useCallback(async()=>{var o;x(!0);try{const l=await I();l.success?(y(l.data||[]),!d&&((o=l.data)==null?void 0:o.length)>0&&!a.conexao_id&&b(g=>({...g,conexao_id:l.data[0].id}))):(h(`Erro ao carregar conexões: ${l.message}`),y([]))}catch(l){h(`Erro crítico ao carregar conexões: ${l.message}`)}finally{x(!1)}},[d,a.conexao_id]);r.useEffect(()=>{i()},[i]),r.useEffect(()=>{u(null)},[a.query,a.conexao_id]);const v=o=>{const{name:l,value:g}=o.target;b(S=>({...S,[l]:g})),h("")},w=async()=>{if(!a.query||!a.conexao_id){h("Selecione uma conexão e insira a consulta SQL para testar.");return}k(!0),u(null),h("");try{const o=await P(a.query,a.conexao_id);u(o)}catch(o){console.error("Erro ao testar consulta:",o),u({success:!1,message:o.message||"Erro desconhecido"})}finally{k(!1)}},f=o=>{if(o.preventDefault(),!a.nome||!a.query||!a.conexao_id){h("Preencha Nome, Consulta SQL e selecione uma Conexão.");return}const l={nome:a.nome,descricao:a.descricao||"",conexao_id:parseInt(a.conexao_id,10),query:a.query,formato_saida:a.formato_saida,transform_type:a.transform_type||null};console.log("[QueryForm] Enviando dados para salvar:",l),j(l)},N=(o,l,g=!1,S="text",F="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:o,className:"block text-sm font-medium text-gray-700 mb-1",children:[l,g&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:S,id:o,name:o,value:a[o],onChange:v,required:g,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:F,disabled:p})]});return e.jsxs("form",{id:"modal-form",onSubmit:f,className:"space-y-4",children:[E&&e.jsx(Q,{type:"error",message:E,onClose:()=>h("")}),t&&e.jsx(Q,{type:t.success?"success":"error",message:`Teste da Consulta: ${t.message}${t.data?` (${t.data.length} linha(s))`:""}`,onClose:()=>u(null),autoClose:!1}),(t==null?void 0:t.success)&&(t==null?void 0:t.data)&&e.jsxs("div",{className:"mt-2 p-3 bg-gray-100 rounded max-h-40 overflow-auto border",children:[e.jsx("pre",{className:"text-xs font-mono",children:JSON.stringify(t.data.slice(0,5),null,2)}),t.data.length>5&&e.jsxs("p",{className:"text-xs text-gray-500",children:["... (mostrando 5 de ",t.data.length," linhas)"]})]}),N("nome","Nome da Consulta",!0,"text","Ex: Buscar Clientes Novos"),N("descricao","Descrição",!1,"text","Consulta para extrair clientes cadastrados hoje"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"conexao_id",className:"block text-sm font-medium text-gray-700 mb-1",children:["Conexão ODBC",e.jsx("span",{className:"text-red-500",children:"*"})]}),m?e.jsx(T,{size:"sm",message:"Carregando conexões..."}):e.jsxs("select",{id:"conexao_id",name:"conexao_id",value:a.conexao_id,onChange:v,required:!0,disabled:p||n.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",disabled:!0,children:n.length===0?"Nenhuma conexão encontrada":"-- Selecione --"}),n.map(o=>e.jsxs("option",{value:o.id,children:[o.nome," (",o.banco,"@",o.host,")"]},o.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"query",className:"block text-sm font-medium text-gray-700 mb-1",children:["Consulta SQL",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{id:"query",name:"query",rows:"8",value:a.query,onChange:v,required:!0,disabled:p,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:"SELECT * FROM Clientes WHERE DataCadastro = TODAY()"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Insira a consulta SQL que será executada."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"formato_saida",className:"block text-sm font-medium text-gray-700",children:"Formato de Saída"}),e.jsxs("select",{id:"formato_saida",name:"formato_saida",value:a.formato_saida,onChange:v,className:"mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2",children:[e.jsx("option",{value:"json",children:"JSON"}),e.jsx("option",{value:"csv",children:"CSV"}),e.jsx("option",{value:"excel",children:"Excel"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"transform_type",className:"block text-sm font-medium text-gray-700",children:"Tipo de Transformação"}),e.jsxs("select",{id:"transform_type",name:"transform_type",value:a.transform_type,onChange:v,className:"mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2",children:[e.jsx("option",{value:"",children:"Nenhuma transformação"}),e.jsx("option",{value:"terceiros",children:"Terceiros (Clientes/Fornecedores)"}),e.jsx("option",{value:"produtos",children:"Produtos (Não implementado)"}),e.jsx("option",{value:"movimentos",children:"Movimentos (Não implementado)"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Selecione um tipo de transformação se necessário padronizar os dados antes do envio."})]}),e.jsx("div",{className:"pt-4",children:e.jsx(C,{type:"button",variant:"secondary",onClick:w,isLoading:p,disabled:p||!a.conexao_id||!a.query||m,className:"w-full sm:w-auto",children:p?"Testando...":"Testar Consulta"})})]})},Z=()=>{const[d,j]=r.useState([]),[_,a]=r.useState(!0),[b,n]=r.useState(""),[y,m]=r.useState(!1),[x,p]=r.useState(null),[k,t]=r.useState(!1),[u,E]=r.useState(null),[h,i]=r.useState({type:"",message:""}),[v,w]=r.useState(!1),[f,N]=r.useState(null),o=r.useCallback(async()=>{a(!0);try{const s=await R();s.success?(j(s.data||[]),n("")):(n(`Erro ao buscar consultas: ${s.message}`),j([]))}catch(s){console.error("Erro crítico ao buscar consultas:",s),n(`Erro crítico ao buscar consultas: ${s.message}`),j([])}finally{a(!1)}},[]);r.useEffect(()=>{o()},[o]);const l=(s=null)=>{p(s),m(!0)},g=()=>{m(!1),p(null)},S=async s=>{console.log("[Queries] Salvando consulta:",s);try{let c;if(!s.query){i({type:"error",message:"A consulta SQL é obrigatória"});return}x&&x.id?c=await J(x.id,s):c=await H(s),c.success?(i({type:"success",message:`Consulta ${x?"atualizada":"criada"} com sucesso!`}),o(),g()):(console.error("Erro ao salvar consulta:",c),i({type:"error",message:`Erro ao salvar: ${c.message}`}))}catch(c){console.error("Erro crítico ao salvar consulta:",c),i({type:"error",message:`Erro ao salvar: ${c.message}`})}},F=s=>{E(s),t(!0)},L=async()=>{if(!(!u||!u.id))try{const s=await V(u.id);s.success?(i({type:"success",message:"Consulta excluída com sucesso!"}),o()):i({type:"error",message:`Erro ao excluir: ${s.message}`})}catch(s){console.error("Erro crítico ao excluir consulta:",s),i({type:"error",message:`Erro ao excluir: ${s.message}`})}finally{t(!1),E(null)}},O=async s=>{if(!(!s||!s.id)){w(!0),N(null);try{const c=await W(s.id);N(c),c.success||i({type:"error",message:`Erro ao executar consulta: ${c.message}`})}catch(c){console.error("Erro crítico ao executar consulta:",c),i({type:"error",message:`Erro ao executar: ${c.message}`})}finally{w(!1)}}},q=[{key:"nome",label:"Nome"},{key:"descricao",label:"Descrição"},{key:"conexao_nome",label:"Conexão",render:s=>s.conexao_nome||"N/A"},{key:"actions",label:"Ações",render:s=>e.jsxs("div",{className:"flex space-x-2 justify-end",children:[e.jsx(C,{variant:"icon",size:"sm",title:"Executar consulta",onClick:()=>O(s),disabled:v,children:e.jsx(D,{className:"text-green-600"})}),e.jsx(C,{variant:"icon",size:"sm",title:"Editar consulta",onClick:()=>l(s),children:e.jsx(M,{className:"text-blue-600"})}),e.jsx(C,{variant:"icon",size:"sm",title:"Excluir consulta",onClick:()=>F(s),children:e.jsx(z,{className:"text-red-600"})})]})}];return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Consultas SQL"}),e.jsx(C,{onClick:()=>l(),leftIcon:e.jsx(A,{}),children:"Nova Consulta"})]}),h.message&&e.jsx(Q,{type:h.type,message:h.message,onClose:()=>i({type:"",message:""})}),b&&e.jsx(Q,{type:"error",message:b,onClose:()=>n("")}),_?e.jsx(T,{message:"Carregando consultas..."}):e.jsx(Y,{columns:q,data:d,emptyMessage:"Nenhuma consulta encontrada. Clique em 'Nova Consulta' para criar.",hoverable:!0}),y&&e.jsx($,{title:x?"Editar Consulta":"Nova Consulta",isOpen:y,onClose:g,footer:e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(C,{variant:"secondary",onClick:g,children:"Cancelar"}),e.jsx(C,{type:"submit",form:"modal-form",children:"Salvar Consulta"})]}),children:e.jsx(G,{query:x,onSave:S,onCancel:g})}),e.jsx(B,{isOpen:k,title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir a consulta "${u==null?void 0:u.nome}"? Esta ação não pode ser desfeita.`,confirmLabel:"Excluir",cancelLabel:"Cancelar",onConfirm:L,onCancel:()=>{t(!1),E(null)},variant:"danger"}),f&&e.jsx($,{title:"Resultado da Execução",isOpen:!!f,onClose:()=>N(null),size:"lg",footer:e.jsx(C,{onClick:()=>N(null),children:"Fechar"}),children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-gray-100 p-4 rounded",children:[e.jsx("h3",{className:"font-bold mb-2",children:f.success?"Consulta executada com sucesso":"Erro na execução"}),f.message&&e.jsx("p",{className:"text-sm text-gray-700 mb-2",children:f.message}),f.data&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm mb-2",children:Array.isArray(f.data)?`${f.data.length} registro(s) encontrado(s)`:"Resultado obtido:"}),e.jsx("div",{className:"max-h-96 overflow-auto",children:e.jsx("pre",{className:"text-xs whitespace-pre-wrap",children:JSON.stringify(f.data,null,2)})})]})]})})})]})};export{Z as default};

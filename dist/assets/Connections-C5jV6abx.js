import{r,j as e,a as q}from"./index-BkTs7LoR.js";import{A as b,B as u,t as H,g as W,M as B,d as G,u as J,c as K,a as X}from"./Alert-DsKoJtNk.js";import{F as Y}from"./index-8obp9P4k.js";const Z=({connection:f,onSave:D,onCancel:y})=>{console.log("[ConnectionForm] Inicializando com connection:",f);const[a,C]=r.useState({nome:"",driver:"SQL Anywhere 17",host:"",porta:"2638",banco:"",usuario:"",senha:"",params:"",...f||{}}),[l,w]=r.useState(!1),[p,c]=r.useState(null),[v,g]=r.useState("");r.useEffect(()=>{c(null)},[a.host,a.porta,a.banco,a.usuario,a.senha,a.driver,a.params]);const N=t=>{const{name:d,value:m}=t.target;console.log(`[ConnectionForm] Campo alterado: ${d} = ${m}`),C(i=>({...i,[d]:m})),g("")},S=async()=>{console.log("[ConnectionForm] Testando conexão com dados:",a),w(!0),c(null),g("");try{const t=await H(a);console.log("[ConnectionForm] Resultado do teste:",t),c(t)}catch(t){console.error("[ConnectionForm] Erro ao testar conexão:",t),c({success:!1,message:t.message||"Erro desconhecido"})}finally{w(!1)}},h=t=>{if(t.preventDefault(),console.log("[ConnectionForm] Submetendo formulário com dados:",a),!a.nome||!a.host||!a.banco||!a.usuario||!a.senha){g("Preencha todos os campos obrigatórios (*).");return}const d={...a,connection_string:`DRIVER={${a.driver}};SERVER=${a.host};PORT=${a.porta};DBN=${a.banco};UID=${a.usuario};PWD=${a.senha};${a.params||""}`,dsn:a.dsn||""};console.log("[ConnectionForm] Enviando dados para salvar:",d),D(d)},x=(t,d,m=!1,i="text",o="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:t,className:"block text-sm font-medium text-gray-700 mb-1",children:[d,m&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:i,id:t,name:t,value:a[t]||"",onChange:N,required:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:o,disabled:l})]}),j=()=>e.jsxs("div",{className:"mt-6 flex space-x-3 justify-end",children:[e.jsx(u,{type:"button",variant:"secondary",onClick:y,disabled:l,children:"Cancelar"}),e.jsx(u,{type:"submit",variant:"primary",disabled:l,children:"Salvar Conexão"})]});return e.jsxs("form",{id:"modal-form",onSubmit:h,className:"space-y-4",children:[v&&e.jsx(b,{type:"error",message:v,onClose:()=>g("")}),p&&e.jsx(b,{type:p.success?"success":"error",message:`Teste de conexão: ${p.message}`,onClose:()=>c(null),autoClose:!1}),x("nome","Nome da Conexão",!0,"text","Ex: Produção Principal"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"driver",className:"block text-sm font-medium text-gray-700 mb-1",children:["Driver ODBC",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsxs("select",{id:"driver",name:"driver",value:a.driver||"SQL Anywhere 17",onChange:N,required:!0,disabled:l,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"SQL Anywhere 17",children:"SQL Anywhere 17"}),e.jsx("option",{value:"SQL Anywhere 16",children:"SQL Anywhere 16"}),e.jsx("option",{value:"SQL Anywhere",children:"SQL Anywhere (Genérico)"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[x("host","Host / Servidor",!0,"text","192.168.1.100 ou NOME_SERVIDOR"),x("porta","Porta",!1,"number","2638")]}),x("banco","Nome do Banco (DatabaseName)",!0,"text","meu_banco"),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[x("usuario","Usuário (UID)",!0),x("senha","Senha (PWD)",!0,"password")]}),x("params","Parâmetros Adicionais",!1,"text","Ex: CharSet=UTF-8;Int=No"),e.jsx("p",{className:"text-xs text-gray-500",children:"Parâmetros extras da string de conexão (chave=valor;chave2=valor2)."}),e.jsxs("div",{className:"pt-4 flex justify-between",children:[e.jsx(u,{type:"button",variant:"secondary",onClick:S,isLoading:l,disabled:l,className:"w-full sm:w-auto",children:l?"Testando...":"Testar Conexão"}),j()]})]})},ee=()=>e.jsx(Y,{}),te=()=>{var A,R,I,T,L,M;const[f,D]=r.useState([]),[y,a]=r.useState(!0),[C,l]=r.useState(null),[w,p]=r.useState(!1),[c,v]=r.useState(null),[g,N]=r.useState(!1),[S,h]=r.useState(null),[x,j]=r.useState(!1),[t,d]=r.useState(null),[m,i]=r.useState(null),[o,P]=r.useState(null),[z,$]=r.useState(!1),E=r.useCallback(async()=>{a(!0),l(null),i(null);try{const s=await W();s.success?D(s.data||[]):l(s.message||"Erro desconhecido ao buscar conexões.")}catch(s){console.error("Catch no fetchConnections:",s),l(s.message||"Erro crítico ao buscar conexões.")}finally{a(!1)}},[]);r.useEffect(()=>{E()},[E]);const F=(s=null)=>{v(s),h(null),p(!0)},k=()=>{g||(p(!1),v(null),h(null))},Q=async s=>{N(!0),h(null),i(null);try{let n;c!=null&&c.id?n=await J(c.id,s):n=await K(s),n.success?(i({type:"success",message:`Conexão "${s.nome}" ${c!=null&&c.id?"atualizada":"criada"} com sucesso!`}),p(!1),E()):h(n.message||`Erro ao ${c!=null&&c.id?"atualizar":"criar"} conexão.`)}catch(n){console.error("Catch no handleSaveConnection:",n),h(n.message||"Erro crítico ao salvar conexão.")}finally{N(!1)}},U=s=>{d(s),j(!0)},V=async()=>{if(t){i(null);try{const s=await X(t.id);s.success?(i({type:"success",message:`Conexão "${t.nome}" excluída com sucesso!`}),E()):i({type:"error",message:s.message||"Erro ao excluir conexão."})}catch(s){console.error("Catch no handleConfirmDelete:",s),i({type:"error",message:s.message||"Erro crítico ao excluir conexão."})}finally{j(!1),d(null)}}},_=async s=>{a(!0);try{console.log(`Iniciando diagnóstico para conexão: ${s.nome} (ID: ${s.id})`),setStatus(`Iniciando diagnóstico para: ${s.nome}...`);const n=await G(s.id);n.success?(console.log("Diagnóstico concluído com sucesso:",n.data),P(n.data),$(!0),n.data.success?setStatus("Diagnóstico concluído: Conexão OK"):setStatus(`Diagnóstico concluído: Encontrados ${n.data.erros.length} problemas`)):(console.error("Erro ao executar diagnóstico:",n.error),setStatus(`Erro ao executar diagnóstico: ${n.error}`))}catch(n){console.error("Exceção ao executar diagnóstico:",n),setStatus(`Erro: ${n.message}`)}finally{a(!1)}};return y?e.jsx(q,{message:"Carregando conexões..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Conexões ODBC"}),e.jsx(u,{variant:"success",onClick:()=>F(),children:"Adicionar Nova Conexão"})]}),C&&e.jsx(b,{type:"error",message:C,onClose:()=>l(null)}),m&&e.jsx(b,{type:m.type,message:m.message,onClose:()=>i(null),autoClose:m.type==="success"}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nome"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Host"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Banco"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuário"}),e.jsx("th",{scope:"col",className:"relative px-6 py-3",children:e.jsx("span",{className:"sr-only",children:"Ações"})})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[f.length===0&&!y&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-4 text-center text-sm text-gray-500",children:"Nenhuma conexão encontrada."})}),f.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.nome}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[s.host,s.porta?`:${s.porta}`:""]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.banco}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.usuario}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3",children:[e.jsx(u,{variant:"secondary",size:"sm",onClick:()=>F(s),children:"Editar"}),e.jsx(u,{variant:"danger",size:"sm",onClick:()=>U(s),children:"Excluir"}),e.jsx("button",{onClick:()=>_(s),disabled:y,className:"btn btn-info btn-sm",title:"Diagnosticar Conexão",children:e.jsx(ee,{})})]})]},s.id))]})]})}),e.jsxs(B,{isOpen:w,onClose:k,title:c?"Editar Conexão":"Adicionar Nova Conexão",size:"lg",preventClose:g,showFooter:!1,children:[S&&e.jsx(b,{type:"error",message:S,onClose:()=>h(null)}),e.jsx(Z,{connection:c,onSave:Q,onCancel:k})]}),e.jsxs(B,{isOpen:x,onClose:()=>j(!1),title:"Confirmar Exclusão",size:"sm",footerContent:e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"secondary",onClick:()=>j(!1),children:"Cancelar"}),e.jsx(u,{variant:"danger",onClick:V,children:"Confirmar Exclusão"})]}),children:[e.jsxs("p",{children:['Tem certeza que deseja excluir a conexão "',e.jsx("strong",{children:t==null?void 0:t.nome}),'"?']}),e.jsx("p",{className:"text-sm text-red-600 mt-2",children:"Esta ação não pode ser desfeita."})]}),z&&o&&e.jsx("div",{className:"modal show d-block",tabIndex:"-1",children:e.jsx("div",{className:"modal-dialog modal-lg",children:e.jsxs("div",{className:"modal-content",children:[e.jsxs("div",{className:"modal-header",children:[e.jsxs("h5",{className:"modal-title",children:["Diagnóstico de Conexão: ",((R=(A=o.detalhes)==null?void 0:A.conexao)==null?void 0:R.nome)||"Conexão"]}),e.jsx("button",{type:"button",className:"btn-close",onClick:()=>$(!1)})]}),e.jsxs("div",{className:"modal-body",children:[e.jsxs("div",{className:"row mb-3",children:[e.jsx("div",{className:"col-md-6",children:e.jsx("div",{className:"card bg-light",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h6",{className:"card-title",children:"Status"}),e.jsx("p",{className:`card-text ${o.success?"text-success":"text-danger"}`,children:o.success?"✅ Conexão estabelecida com sucesso":"❌ Falha na conexão"})]})})}),e.jsx("div",{className:"col-md-6",children:e.jsx("div",{className:"card bg-light",children:e.jsxs("div",{className:"card-body",children:[e.jsx("h6",{className:"card-title",children:"Tempo de execução"}),e.jsx("p",{className:"card-text",children:o.tempoExecucao?`${(o.tempoExecucao/1e3).toFixed(2)} segundos`:"N/A"})]})})})]}),((I=o.detalhes)==null?void 0:I.conexao)&&e.jsxs("div",{className:"card mb-3",children:[e.jsx("div",{className:"card-header",children:"Detalhes da Conexão"}),e.jsx("div",{className:"card-body",children:e.jsxs("div",{className:"row",children:[e.jsxs("div",{className:"col-md-6",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Nome:"})," ",o.detalhes.conexao.nome]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Driver:"})," ",o.detalhes.conexao.driver]})]}),e.jsxs("div",{className:"col-md-6",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Servidor:"})," ",o.detalhes.conexao.servidor]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Banco:"})," ",o.detalhes.conexao.banco]})]})]})})]}),o.erros&&o.erros.length>0&&e.jsxs("div",{className:"card mb-3 border-danger",children:[e.jsx("div",{className:"card-header bg-danger text-white",children:"Erros Detectados"}),e.jsx("div",{className:"card-body",children:e.jsx("ul",{className:"list-group",children:o.erros.map((s,n)=>{var O;return e.jsxs("li",{className:"list-group-item",children:[e.jsx("h6",{className:"fw-bold",children:s.codigo}),e.jsx("p",{children:s.mensagem}),((O=o.detalhes)==null?void 0:O.explicacao)&&e.jsx("div",{className:"alert alert-info mt-2",children:o.detalhes.explicacao})]},n)})})})]}),o.success&&e.jsxs("div",{className:"card mb-3",children:[e.jsx("div",{className:"card-header",children:"Informações Técnicas"}),e.jsxs("div",{className:"card-body",children:[e.jsxs("div",{className:"row",children:[e.jsx("div",{className:"col-md-6",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Tempo de Conexão:"})," ",(T=o.detalhes)!=null&&T.tempoConexao?`${o.detalhes.tempoConexao} ms`:"N/A"]})}),e.jsx("div",{className:"col-md-6",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Tempo de Consulta:"})," ",(L=o.detalhes)!=null&&L.tempoConsulta?`${o.detalhes.tempoConsulta} ms`:"N/A"]})})]}),((M=o.detalhes)==null?void 0:M.infoServidor)&&e.jsxs("div",{className:"mt-3",children:[e.jsx("h6",{children:"Informações do Servidor"}),e.jsx("pre",{className:"bg-light p-2 rounded",children:JSON.stringify(o.detalhes.infoServidor,null,2)})]})]})]})]}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{type:"button",className:"btn btn-secondary",onClick:()=>$(!1),children:"Fechar"})})]})})})]})};export{te as default};

import{j as e,r as t,a as L}from"./index-BkTs7LoR.js";import{a as z,b as A,c as D,d as M}from"./index-8obp9P4k.js";import{g as I,A as _,B as C,b as B,M as F,e as R,f as P,h as J,i as V,j as H}from"./Alert-DsKoJtNk.js";const W=({columns:i=[],data:b=[],emptyMessage:N="Nenhum dado encontrado",hoverable:a=!1,className:j=""})=>b.length?e.jsx("div",{className:`overflow-x-auto ${j}`,children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 border",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:i.map((o,u)=>e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:o.label||o.key},o.key||u))})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:b.map((o,u)=>e.jsx("tr",{className:a?"hover:bg-gray-50":"",children:i.map((d,m)=>e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:d.render?d.render(o):o[d.key]!==void 0?String(o[d.key]):"-"},`${u}-${d.key||m}`))},o.id||u))})]})}):e.jsx("div",{className:"bg-gray-50 border rounded p-8 text-center text-gray-500",children:N}),Y=({query:i,onSave:b,onCancel:N})=>{const[a,j]=t.useState({nome:"",descricao:"",query:"",conexao_id:"",formato_saida:"json",...i||{}});t.useEffect(()=>{i&&i.sql&&!a.query&&j(r=>({...r,query:i.sql}))},[i]);const[o,u]=t.useState([]),[d,m]=t.useState(!0),[h,k]=t.useState(!1),[n,g]=t.useState(null),[E,f]=t.useState(""),x=t.useCallback(async()=>{var r;m(!0);try{const l=await I();l.success?(u(l.data||[]),!i&&((r=l.data)==null?void 0:r.length)>0&&!a.conexao_id&&j(p=>({...p,conexao_id:l.data[0].id}))):(f(`Erro ao carregar conexões: ${l.message}`),u([]))}catch(l){f(`Erro crítico ao carregar conexões: ${l.message}`)}finally{m(!1)}},[i,a.conexao_id]);t.useEffect(()=>{x()},[x]),t.useEffect(()=>{g(null)},[a.query,a.conexao_id]);const S=r=>{const{name:l,value:p}=r.target;j(w=>({...w,[l]:p})),f("")},Q=async()=>{if(!a.query||!a.conexao_id){f("Selecione uma conexão e insira a consulta SQL para testar.");return}k(!0),g(null),f("");try{const r=await B(a.query,a.conexao_id);g(r)}catch(r){console.error("Erro ao testar consulta:",r),g({success:!1,message:r.message||"Erro desconhecido"})}finally{k(!1)}},y=r=>{if(r.preventDefault(),!a.nome||!a.query||!a.conexao_id){f("Preencha Nome, Consulta SQL e selecione uma Conexão.");return}const l={nome:a.nome,descricao:a.descricao||"",conexao_id:parseInt(a.conexao_id,10),query:a.query,formato_saida:a.formato_saida};console.log("[QueryForm] Enviando dados para salvar:",l),b(l)},v=(r,l,p=!1,w="text",$="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:r,className:"block text-sm font-medium text-gray-700 mb-1",children:[l,p&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:w,id:r,name:r,value:a[r],onChange:S,required:p,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:$,disabled:h})]});return e.jsxs("form",{id:"modal-form",onSubmit:y,className:"space-y-4",children:[E&&e.jsx(_,{type:"error",message:E,onClose:()=>f("")}),n&&e.jsx(_,{type:n.success?"success":"error",message:`Teste da Consulta: ${n.message}${n.data?` (${n.data.length} linha(s))`:""}`,onClose:()=>g(null),autoClose:!1}),(n==null?void 0:n.success)&&(n==null?void 0:n.data)&&e.jsxs("div",{className:"mt-2 p-3 bg-gray-100 rounded max-h-40 overflow-auto border",children:[e.jsx("pre",{className:"text-xs font-mono",children:JSON.stringify(n.data.slice(0,5),null,2)}),n.data.length>5&&e.jsxs("p",{className:"text-xs text-gray-500",children:["... (mostrando 5 de ",n.data.length," linhas)"]})]}),v("nome","Nome da Consulta",!0,"text","Ex: Buscar Clientes Novos"),v("descricao","Descrição",!1,"text","Consulta para extrair clientes cadastrados hoje"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"conexao_id",className:"block text-sm font-medium text-gray-700 mb-1",children:["Conexão ODBC",e.jsx("span",{className:"text-red-500",children:"*"})]}),d?e.jsx(L,{size:"sm",message:"Carregando conexões..."}):e.jsxs("select",{id:"conexao_id",name:"conexao_id",value:a.conexao_id,onChange:S,required:!0,disabled:h||o.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",disabled:!0,children:o.length===0?"Nenhuma conexão encontrada":"-- Selecione --"}),o.map(r=>e.jsxs("option",{value:r.id,children:[r.nome," (",r.banco,"@",r.host,")"]},r.id))]})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"query",className:"block text-sm font-medium text-gray-700 mb-1",children:["Consulta SQL",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{id:"query",name:"query",rows:"8",value:a.query,onChange:S,required:!0,disabled:h,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:"SELECT * FROM Clientes WHERE DataCadastro = TODAY()"}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Insira a consulta SQL que será executada."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"formato_saida",className:"block text-sm font-medium text-gray-700",children:"Formato de Saída"}),e.jsxs("select",{id:"formato_saida",name:"formato_saida",value:a.formato_saida,onChange:S,className:"mt-1 block w-full rounded-md border border-gray-300 shadow-sm p-2",children:[e.jsx("option",{value:"json",children:"JSON"}),e.jsx("option",{value:"csv",children:"CSV"}),e.jsx("option",{value:"excel",children:"Excel"})]})]}),e.jsx("div",{className:"pt-4",children:e.jsx(C,{type:"button",variant:"secondary",onClick:Q,isLoading:h,disabled:h||!a.conexao_id||!a.query||d,className:"w-full sm:w-auto",children:h?"Testando...":"Testar Consulta"})})]})},G=({isOpen:i,title:b="Confirmar",message:N="Tem certeza que deseja realizar esta ação?",confirmLabel:a="Confirmar",cancelLabel:j="Cancelar",onConfirm:o,onCancel:u,variant:d="primary"})=>{const m=()=>{switch(d){case"danger":return"bg-red-50 text-red-700 border-red-200";case"warning":return"bg-yellow-50 text-yellow-700 border-yellow-200";default:return"bg-blue-50 text-blue-700 border-blue-200"}},h=()=>{switch(d){case"danger":return"danger";case"warning":return"warning";default:return"primary"}};return e.jsx(F,{isOpen:i,onClose:u,title:b,footer:e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(C,{variant:"secondary",onClick:u,children:j}),e.jsx(C,{variant:h(),onClick:o,children:a})]}),size:"sm",children:e.jsx("div",{className:`p-4 border rounded ${m()}`,children:e.jsx("p",{children:N})})})},Z=()=>{const[i,b]=t.useState([]),[N,a]=t.useState(!0),[j,o]=t.useState(""),[u,d]=t.useState(!1),[m,h]=t.useState(null),[k,n]=t.useState(!1),[g,E]=t.useState(null),[f,x]=t.useState({type:"",message:""}),[S,Q]=t.useState(!1),[y,v]=t.useState(null),r=t.useCallback(async()=>{a(!0);try{const s=await R();s.success?(b(s.data||[]),o("")):(o(`Erro ao buscar consultas: ${s.message}`),b([]))}catch(s){console.error("Erro crítico ao buscar consultas:",s),o(`Erro crítico ao buscar consultas: ${s.message}`),b([])}finally{a(!1)}},[]);t.useEffect(()=>{r()},[r]);const l=(s=null)=>{h(s),d(!0)},p=()=>{d(!1),h(null)},w=async s=>{console.log("[Queries] Salvando consulta:",s);try{let c;if(!s.query){x({type:"error",message:"A consulta SQL é obrigatória"});return}m&&m.id?c=await P(m.id,s):c=await J(s),c.success?(x({type:"success",message:`Consulta ${m?"atualizada":"criada"} com sucesso!`}),r(),p()):(console.error("Erro ao salvar consulta:",c),x({type:"error",message:`Erro ao salvar: ${c.message}`}))}catch(c){console.error("Erro crítico ao salvar consulta:",c),x({type:"error",message:`Erro ao salvar: ${c.message}`})}},$=s=>{E(s),n(!0)},O=async()=>{if(!(!g||!g.id))try{const s=await V(g.id);s.success?(x({type:"success",message:"Consulta excluída com sucesso!"}),r()):x({type:"error",message:`Erro ao excluir: ${s.message}`})}catch(s){console.error("Erro crítico ao excluir consulta:",s),x({type:"error",message:`Erro ao excluir: ${s.message}`})}finally{n(!1),E(null)}},q=async s=>{if(!(!s||!s.id)){Q(!0),v(null);try{const c=await H(s.id);v(c),c.success||x({type:"error",message:`Erro ao executar consulta: ${c.message}`})}catch(c){console.error("Erro crítico ao executar consulta:",c),x({type:"error",message:`Erro ao executar: ${c.message}`})}finally{Q(!1)}}},T=[{key:"nome",label:"Nome"},{key:"descricao",label:"Descrição"},{key:"conexao_nome",label:"Conexão",render:s=>s.conexao_nome||"N/A"},{key:"actions",label:"Ações",render:s=>e.jsxs("div",{className:"flex space-x-2 justify-end",children:[e.jsx(C,{variant:"icon",size:"sm",title:"Executar consulta",onClick:()=>q(s),disabled:S,children:e.jsx(A,{className:"text-green-600"})}),e.jsx(C,{variant:"icon",size:"sm",title:"Editar consulta",onClick:()=>l(s),children:e.jsx(D,{className:"text-blue-600"})}),e.jsx(C,{variant:"icon",size:"sm",title:"Excluir consulta",onClick:()=>$(s),children:e.jsx(M,{className:"text-red-600"})})]})}];return e.jsxs("div",{className:"container mx-auto px-4 py-8",children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-800",children:"Consultas SQL"}),e.jsx(C,{onClick:()=>l(),leftIcon:e.jsx(z,{}),children:"Nova Consulta"})]}),f.message&&e.jsx(_,{type:f.type,message:f.message,onClose:()=>x({type:"",message:""})}),j&&e.jsx(_,{type:"error",message:j,onClose:()=>o("")}),N?e.jsx(L,{message:"Carregando consultas..."}):e.jsx(W,{columns:T,data:i,emptyMessage:"Nenhuma consulta encontrada. Clique em 'Nova Consulta' para criar.",hoverable:!0}),u&&e.jsx(F,{title:m?"Editar Consulta":"Nova Consulta",isOpen:u,onClose:p,footer:e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(C,{variant:"secondary",onClick:p,children:"Cancelar"}),e.jsx(C,{type:"submit",form:"modal-form",children:"Salvar Consulta"})]}),children:e.jsx(Y,{query:m,onSave:w,onCancel:p})}),e.jsx(G,{isOpen:k,title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir a consulta "${g==null?void 0:g.nome}"? Esta ação não pode ser desfeita.`,confirmLabel:"Excluir",cancelLabel:"Cancelar",onConfirm:O,onCancel:()=>{n(!1),E(null)},variant:"danger"}),y&&e.jsx(F,{title:"Resultado da Execução",isOpen:!!y,onClose:()=>v(null),size:"lg",footer:e.jsx(C,{onClick:()=>v(null),children:"Fechar"}),children:e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"bg-gray-100 p-4 rounded",children:[e.jsx("h3",{className:"font-bold mb-2",children:y.success?"Consulta executada com sucesso":"Erro na execução"}),y.message&&e.jsx("p",{className:"text-sm text-gray-700 mb-2",children:y.message}),y.data&&e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-sm mb-2",children:Array.isArray(y.data)?`${y.data.length} registro(s) encontrado(s)`:"Resultado obtido:"}),e.jsx("div",{className:"max-h-96 overflow-auto",children:e.jsx("pre",{className:"text-xs whitespace-pre-wrap",children:JSON.stringify(y.data,null,2)})})]})]})})})]})};export{Z as default};

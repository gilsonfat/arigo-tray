import{r as a,j as e,a as O}from"./index-BkTs7LoR.js";import{e as z,A as E,k as D,B as j,M,l as R,m as q,n as J,o as B}from"./Alert-DsKoJtNk.js";const Q=()=>e.jsxs("div",{className:"text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded border",children:["Formato Cron: Minuto Hora DiaMês Mês DiaSemana ",e.jsx("br",{}),"(* = qualquer valor, */5 = a cada 5) ",e.jsx("br",{}),"Ex: ",e.jsx("code",{children:"0 9 * * 1-5"})," (9h de Seg a Sex) | ",e.jsx("code",{children:"*/15 * * * *"})," (A cada 15 min) ",e.jsx("br",{}),e.jsx("a",{href:"https://crontab.guru/",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"Testar expressão Cron"})]}),U=({task:y,onSave:_,onCancel:L})=>{const[r,C]=a.useState({nome:"",descricao:"",cron:"",consulta_id:"",api_url:"",api_metodo:"POST",api_headers:"{}",ativo:!0,...y||{}}),[p,w]=a.useState([]),[T,o]=a.useState(!0),[m,l]=a.useState(""),[b,S]=a.useState(!0),x=a.useCallback(async()=>{var t;o(!0);try{const c=await z();c.success?(w(c.data||[]),!y&&((t=c.data)==null?void 0:t.length)>0&&!r.consulta_id&&C(h=>({...h,consulta_id:c.data[0].id}))):(l(`Erro ao carregar consultas: ${c.message}`),w([]))}catch(c){l(`Erro crítico ao carregar consultas: ${c.message}`)}finally{o(!1)}},[y,r.consulta_id]);a.useEffect(()=>{x()},[x]),a.useEffect(()=>{try{JSON.parse(r.api_headers||"{}"),S(!0),m==="O formato dos Headers (JSON) é inválido."&&l("")}catch{S(!1)}},[r.api_headers,m]);const f=t=>{const{name:c,value:h,type:g,checked:n}=t.target;C(N=>({...N,[c]:g==="checkbox"?n:h})),m&&m!=="O formato dos Headers (JSON) é inválido."&&l("")},v=t=>{if(t.preventDefault(),!r.nome||!r.cron||!r.consulta_id||!r.api_url){l("Preencha Nome, Cron, Consulta e URL da API.");return}if(!b){l("O formato dos Headers (JSON) é inválido.");return}_(r)},u=(t,c,h=!1,g="text",n="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:t,className:"block text-sm font-medium text-gray-700 mb-1",children:[c,h&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:g,id:t,name:t,value:r[t],onChange:f,required:h,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:n})]});return e.jsxs("form",{id:"modal-form",onSubmit:v,className:"space-y-4",children:[m&&e.jsx(E,{type:"error",message:m,onClose:()=>l("")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[u("nome","Nome da Tarefa",!0,"text","Ex: Enviar Vendas Diárias"),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ativo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",id:"ativo",name:"ativo",checked:r.ativo,onChange:f,className:"sr-only peer"}),e.jsx("div",{className:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"}),e.jsx("span",{className:"ms-3 text-sm font-medium text-gray-900",children:r.ativo?"Ativa":"Inativa"})]})]})]}),u("descricao","Descrição",!1,"text","Envia dados consolidados para API Xpto"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"cron",className:"block text-sm font-medium text-gray-700 mb-1",children:["Frequência (Expressão Cron)",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"cron",name:"cron",value:r.cron,onChange:f,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"0 9 * * 1-5"}),e.jsx(Q,{})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"consulta_id",className:"block text-sm font-medium text-gray-700 mb-1",children:["Consulta SQL a ser executada",e.jsx("span",{className:"text-red-500",children:"*"})]}),T?e.jsx(O,{size:"sm",message:"Carregando consultas..."}):e.jsxs("select",{id:"consulta_id",name:"consulta_id",value:r.consulta_id,onChange:f,required:!0,disabled:p.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",disabled:!0,children:p.length===0?"Nenhuma consulta SQL encontrada":"-- Selecione a Consulta --"}),p.map(t=>e.jsx("option",{value:t.id,children:t.nome},t.id))]})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-800 pt-4 border-t mt-6",children:"Destino da API"}),u("api_url","URL da API",!0,"url","https://api.exemplo.com/dados"),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{htmlFor:"api_metodo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Método HTTP"}),e.jsxs("select",{id:"api_metodo",name:"api_metodo",value:r.api_metodo,onChange:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"POST",children:"POST"}),e.jsx("option",{value:"PUT",children:"PUT"}),e.jsx("option",{value:"PATCH",children:"PATCH"})]})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"api_headers",className:"block text-sm font-medium text-gray-700 mb-1",children:"Headers da Requisição (JSON)"}),e.jsx("textarea",{id:"api_headers",name:"api_headers",rows:"3",value:r.api_headers,onChange:f,className:`w-full px-3 py-2 border rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${b?"border-gray-300":"border-red-500 focus:ring-red-500"}`,placeholder:'{ "Content-Type": "application/json", "Authorization": "Bearer SEU_TOKEN" }'}),!b&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Formato JSON inválido."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Insira os cabeçalhos HTTP como um objeto JSON válido."})]})]})},V=()=>e.jsxs("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),W=()=>e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),K=()=>e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),Y=()=>{const[y,_]=a.useState([]),[L,r]=a.useState(!0),[C,p]=a.useState(null),[w,T]=a.useState(!1),[o,m]=a.useState(null),[l,b]=a.useState(!1),[S,x]=a.useState(null),[f,v]=a.useState(!1),[u,t]=a.useState(null),[c,h]=a.useState(null),[g,n]=a.useState(null),N=a.useCallback(async()=>{r(!0),p(null),n(null);try{const s=await D();if(s.success){const i=(s.data||[]).sort((d,H)=>d.nome.localeCompare(H.nome));_(i)}else p(s.message||"Erro desconhecido ao buscar tarefas.")}catch(s){console.error("Catch no fetchTasks:",s),p(s.message||"Erro crítico ao buscar tarefas.")}finally{r(!1)}},[]);a.useEffect(()=>{N()},[N]);const A=(s=null)=>{m(s),x(null),T(!0)},k=()=>{l||(T(!1),m(null),x(null))},P=async s=>{b(!0),x(null),n(null);try{let i;const d={...s,ativo:s.ativo?1:0};o!=null&&o.id?i=await q(o.id,d):i=await J(d),i.success?(k(),N(),n({type:"success",message:`Tarefa "${s.nome}" ${o!=null&&o.id?"atualizada":"criada"} com sucesso!`})):x(i.message||`Falha ao ${o!=null&&o.id?"atualizar":"criar"} tarefa.`)}catch(i){console.error("Catch no handleSaveTask:",i),x(i.message||"Erro crítico ao salvar tarefa.")}finally{b(!1)}},F=s=>{t(s),v(!0)},I=async()=>{if(u){n(null);try{const s=await B(u.id);s.success?(n({type:"success",message:`Tarefa "${u.nome}" excluída com sucesso!`}),N()):n({type:"error",message:s.message||"Erro ao excluir tarefa."})}catch(s){console.error("Catch no handleConfirmDelete:",s),n({type:"error",message:s.message||"Erro crítico ao excluir tarefa."})}finally{v(!1),t(null)}}},$=async(s,i)=>{h(s),n(null);try{const d=await R(s);d.success?n({type:"success",message:`Tarefa "${i}" executada manualmente com sucesso! ${d.message||""}`.trim()}):n({type:"error",message:`Falha ao executar tarefa "${i}": ${d.message||"Erro desconhecido"}`})}catch(d){console.error("Catch no handleExecuteTask:",d),n({type:"error",message:`Erro crítico ao executar tarefa "${i}": ${d.message}`})}finally{h(null)}};return L?e.jsx(O,{message:"Carregando tarefas agendadas..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Tarefas Agendadas"}),e.jsx(j,{variant:"success",onClick:()=>A(),children:"Adicionar Nova Tarefa"})]}),C&&e.jsx(E,{type:"error",message:C,onClose:()=>p(null)}),g&&e.jsx(E,{type:g.type,message:g.message,onClose:()=>n(null),autoClose:g.type==="success"}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nome"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cron"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Consulta"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"API URL"}),e.jsx("th",{scope:"col",className:"relative px-6 py-3",children:e.jsx("span",{className:"sr-only",children:"Ações"})})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[y.length===0&&!L&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-6 py-4 text-center text-sm text-gray-500",children:"Nenhuma tarefa agendada encontrada."})}),y.map(s=>e.jsxs("tr",{className:s.ativo?"":"bg-gray-50 opacity-70",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.ativo?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[e.jsx("span",{className:`w-2 h-2 mr-1.5 rounded-full ${s.ativo?"bg-green-500":"bg-red-500"}`}),s.ativo?"Ativa":"Inativa"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.nome}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono",children:s.cron}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.nome_consulta||"N/A"})," ",e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate",title:s.api_url,children:s.api_url}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2",children:[e.jsx(j,{variant:"info",size:"sm",onClick:()=>$(s.id,s.nome),isLoading:c===s.id,disabled:c===s.id||!s.ativo,title:"Executar Tarefa Agora",className:"px-2 py-1",children:e.jsx(V,{})}),e.jsx(j,{variant:"secondary",size:"sm",onClick:()=>A(s),title:"Editar Tarefa",className:"px-2 py-1",children:e.jsx(W,{})}),e.jsx(j,{variant:"danger",size:"sm",onClick:()=>F(s),title:"Excluir Tarefa",className:"px-2 py-1",children:e.jsx(K,{})})]})]},s.id))]})]})}),e.jsxs(M,{isOpen:w,onClose:k,title:o?"Editar Tarefa Agendada":"Adicionar Nova Tarefa",size:"lg",preventClose:l,footerContent:e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(j,{variant:"secondary",onClick:k,disabled:l,children:"Cancelar"}),e.jsx(j,{type:"submit",form:"modal-form",variant:"primary",isLoading:l,disabled:l,children:l?"Salvando...":"Salvar Tarefa"})]}),children:[S&&e.jsx(E,{type:"error",message:S,onClose:()=>x(null)}),w&&e.jsx(U,{task:o,onSave:P,onCancel:k},(o==null?void 0:o.id)||"new-task")]}),e.jsxs(M,{isOpen:f,onClose:()=>v(!1),title:"Confirmar Exclusão",size:"sm",footerContent:e.jsxs(e.Fragment,{children:[e.jsx(j,{variant:"secondary",onClick:()=>v(!1),children:"Cancelar"}),e.jsx(j,{variant:"danger",onClick:I,children:"Confirmar Exclusão"})]}),children:[e.jsxs("p",{children:['Tem certeza que deseja excluir a tarefa "',e.jsx("strong",{children:u==null?void 0:u.nome}),'"?']}),e.jsx("p",{className:"text-sm text-red-600 mt-2",children:"Isso removerá o agendamento. Esta ação não pode ser desfeita."})]})]})};export{Y as default};

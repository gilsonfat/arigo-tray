import{r as o,j as e,a as M}from"./index-JjGluSb1.js";import{A as F,B as v,g as _,t as W,a as G,M as Q,C as J,d as K,u as X,c as Y,b as Z}from"./ConfirmDialog-CWlH6QHb.js";import{F as z,a as ee,b as P,c as se,d as ae,e as re}from"./index-BPE1NJCr.js";const te=({connection:l,onSave:r,onCancel:g})=>{console.log("[ConnectionForm] Inicializando com connection:",l);const[a,j]=o.useState({nome:"",driver:"SQL Anywhere 17",host:"",porta:"2638",banco:"",usuario:"",senha:"",params:"",...l||{}}),[c,N]=o.useState(!1),[h,t]=o.useState(null),[x,b]=o.useState(""),[E,w]=o.useState([]),[p,A]=o.useState(!1);o.useEffect(()=>{(async()=>{try{A(!0),console.log("[ConnectionForm] Carregando drivers ODBC disponíveis...");const n=await _();console.log("[ConnectionForm] Drivers ODBC disponíveis:",n),n&&n.length>0?(w(n),!a.driver&&n.length>0&&j(f=>({...f,driver:n[0]}))):(console.warn("[ConnectionForm] Nenhum driver ODBC encontrado"),w(["SQL Anywhere 17","SQL Anywhere 16","SQL Anywhere"]))}catch(n){console.error("[ConnectionForm] Erro ao carregar drivers ODBC:",n),w(["SQL Anywhere 17","SQL Anywhere 16","SQL Anywhere"])}finally{A(!1)}})()},[]),o.useEffect(()=>{t(null)},[a.host,a.porta,a.banco,a.usuario,a.senha,a.driver,a.params]);const S=i=>{const{name:n,value:f}=i.target;console.log(`[ConnectionForm] Campo alterado: ${n} = ${f}`),j(C=>({...C,[n]:f})),b("")},y=async()=>{console.log("[ConnectionForm] Testando conexão com dados:",a),N(!0),t(null),b("");try{const i=await W(a);console.log("[ConnectionForm] Resultado do teste:",i),t(i)}catch(i){console.error("[ConnectionForm] Erro ao testar conexão:",i),t({success:!1,message:i.message||"Erro desconhecido"})}finally{N(!1)}},L=i=>{if(i.preventDefault(),console.log("[ConnectionForm] Submetendo formulário com dados:",a),!a.nome||!a.host||!a.banco||!a.usuario||!a.senha){b("Preencha todos os campos obrigatórios (*).");return}const n={...a,connection_string:`DRIVER={${a.driver}};SERVER=${a.host};PORT=${a.porta};DBN=${a.banco};UID=${a.usuario};PWD=${a.senha};${a.params||""}`,dsn:a.dsn||""};console.log("[ConnectionForm] Enviando dados para salvar:",n),r(n)},m=(i,n,f=!1,C="text",D="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:i,className:"block text-sm font-medium text-gray-700 mb-1",children:[n,f&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:C,id:i,name:i,value:a[i]||"",onChange:S,required:f,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",placeholder:D,disabled:c})]}),u=()=>e.jsxs("div",{className:"mt-6 flex space-x-3 justify-end",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:g,disabled:c,children:"Cancelar"}),e.jsx(v,{type:"submit",variant:"primary",disabled:c,children:"Salvar Conexão"})]});return e.jsxs("form",{id:"modal-form",onSubmit:L,className:"space-y-4",children:[x&&e.jsx(F,{type:"error",message:x,onClose:()=>b("")}),h&&e.jsx(F,{type:h.success?"success":"error",message:`Teste de conexão: ${h.message}`,onClose:()=>t(null),autoClose:!1}),m("nome","Nome da Conexão",!0,"text","Ex: Produção Principal"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"driver",className:"block text-sm font-medium text-gray-700 mb-1",children:["Driver ODBC",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("select",{id:"driver",name:"driver",value:a.driver||"",onChange:S,required:!0,disabled:c||p,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:p?e.jsx("option",{value:"",children:"Carregando drivers..."}):E.length>0?E.map((i,n)=>e.jsx("option",{value:i,children:i},n)):e.jsx("option",{value:"",children:"Nenhum driver encontrado"})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[m("host","Host / Servidor",!0,"text","192.168.1.100 ou NOME_SERVIDOR"),m("porta","Porta",!1,"number","2638")]}),m("banco","Nome do Banco (DatabaseName)",!0,"text","meu_banco"),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[m("usuario","Usuário (UID)",!0),m("senha","Senha (PWD)",!0,"password")]}),m("params","Parâmetros Adicionais",!1,"text","Ex: CharSet=UTF-8;Int=No"),e.jsx("p",{className:"text-xs text-gray-500",children:"Parâmetros extras da string de conexão (chave=valor;chave2=valor2)."}),e.jsxs("div",{className:"pt-4 flex justify-between",children:[e.jsx(v,{type:"button",variant:"secondary",onClick:y,isLoading:c,disabled:c,className:"w-full sm:w-auto",children:c?"Testando...":"Testar Conexão"}),u()]})]})},oe=({results:l,connection:r})=>{var h;if(!l)return e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(z,{className:"text-gray-400 text-4xl mx-auto mb-2"}),e.jsx("p",{className:"text-gray-500",children:"Nenhum resultado de diagnóstico disponível."})]});const g=(h=r==null?void 0:r.driver)==null?void 0:h.toLowerCase().includes("sql anywhere"),a=t=>{switch(t){case"ok":return e.jsx(ae,{className:"text-green-500 text-xl"});case"erro":return e.jsx(se,{className:"text-red-500 text-xl"});case"aviso":return e.jsx(P,{className:"text-yellow-500 text-xl"});case"verificar":return g?e.jsx(ee,{className:"text-blue-500 text-xl"}):e.jsx(P,{className:"text-blue-500 text-xl"});default:return e.jsx(z,{className:"text-gray-400 text-xl"})}},j=t=>{switch(t){case"ok":return"bg-green-50 border-green-200";case"erro":return"bg-red-50 border-red-200";case"aviso":return"bg-yellow-50 border-yellow-200";case"verificar":return"bg-blue-50 border-blue-200";default:return"bg-gray-50 border-gray-200"}},c=({title:t,data:x})=>e.jsxs("div",{className:`border p-4 rounded-md mb-3 ${j(x.status)}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a(x.status),e.jsx("h3",{className:"font-medium text-gray-800",children:t})]}),e.jsx("p",{className:"text-sm mb-1",children:x.mensagem}),x.sugestao&&e.jsxs("p",{className:"text-sm italic text-gray-600",children:[e.jsx("strong",{children:"Sugestão:"})," ",x.sugestao]})]}),N=()=>l.resultado.status==="ok"?"A conexão foi testada com sucesso!":l.resultado.status==="verificar"?"O SQL Anywhere pode estar funcionando corretamente, mesmo que o diagnóstico não consiga verificar completamente. Teste executando consultas.":"Foram encontrados problemas com a conexão SQL Anywhere.";return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"mb-4 text-center",children:[e.jsxs("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:["Diagnóstico da Conexão: ",(r==null?void 0:r.nome)||"Conexão"]}),e.jsx("p",{className:"text-sm text-gray-600",children:g?N():l.resultado.status==="ok"?"A conexão foi testada com sucesso!":"Foram encontrados problemas com a conexão."})]}),e.jsxs("div",{className:`border p-4 rounded-md mb-5 ${j(l.resultado.status)}`,children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[a(l.resultado.status),e.jsx("h3",{className:"font-medium text-gray-800",children:"Resultado Final"})]}),e.jsx("p",{className:"text-md mb-1 font-medium",children:l.resultado.mensagem}),l.resultado.sugestao&&e.jsxs("p",{className:"text-sm italic",children:[e.jsx("strong",{children:"Sugestão:"})," ",l.resultado.sugestao]}),g&&l.resultado.status==="verificar"&&e.jsxs("p",{className:"mt-2 text-sm bg-blue-100 p-2 rounded",children:[e.jsx("strong",{children:"Nota:"})," Conexões SQL Anywhere podem funcionar normalmente mesmo quando o diagnóstico não consegue se conectar. Isso pode ocorrer devido às especificidades do driver. Recomendamos testar a conexão executando consultas reais."]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(c,{title:"Driver ODBC",data:l.driver}),e.jsx(c,{title:"Servidor",data:l.servidor}),e.jsx(c,{title:"Credenciais",data:l.credenciais}),e.jsx(c,{title:"Banco de Dados",data:l.banco})]}),e.jsxs("div",{className:"mt-6 border border-gray-200 rounded-md p-4 bg-gray-50",children:[e.jsx("h3",{className:"font-medium text-gray-800 mb-2",children:"Detalhes da Conexão"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx("strong",{children:"Nome:"})," ",(r==null?void 0:r.nome)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Driver:"})," ",(r==null?void 0:r.driver)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Host:"})," ",(r==null?void 0:r.host)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Porta:"})," ",(r==null?void 0:r.porta)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Banco:"})," ",(r==null?void 0:r.banco)||"N/A"]}),e.jsxs("div",{children:[e.jsx("strong",{children:"Usuário:"})," ",(r==null?void 0:r.usuario)||"N/A"]})]})]})]})},ne=()=>e.jsx(re,{}),de=()=>{const[l,r]=o.useState([]),[g,a]=o.useState(!0),[j,c]=o.useState(null),[N,h]=o.useState(!1),[t,x]=o.useState(null),[b,E]=o.useState(!1),[w,p]=o.useState(null),[A,S]=o.useState(!1),[y,L]=o.useState(null),[m,u]=o.useState(null),[i,n]=o.useState(null),[f,C]=o.useState(!1),[D,R]=o.useState(null),[k,O]=o.useState(!1),$=o.useCallback(async()=>{a(!0),c(null),u(null);try{const s=await G();s.success?r(s.data||[]):c(s.message||"Erro desconhecido ao buscar conexões.")}catch(s){console.error("Catch no fetchConnections:",s),c(s.message||"Erro crítico ao buscar conexões.")}finally{a(!1)}},[]);o.useEffect(()=>{$()},[$]);const B=(s=null)=>{x(s),p(null),h(!0)},I=()=>{b||(h(!1),x(null),p(null))},U=async s=>{E(!0),p(null),u(null);try{let d;t!=null&&t.id?d=await X(t.id,s):d=await Y(s),d.success?(u({type:"success",message:`Conexão "${s.nome}" ${t!=null&&t.id?"atualizada":"criada"} com sucesso!`}),h(!1),$()):p(d.message||`Erro ao ${t!=null&&t.id?"atualizar":"criar"} conexão.`)}catch(d){console.error("Catch no handleSaveConnection:",d),p(d.message||"Erro crítico ao salvar conexão.")}finally{E(!1)}},q=s=>{L(s),S(!0)},H=async()=>{if(y){u(null);try{const s=await Z(y.id);s.success?(u({type:"success",message:`Conexão "${y.nome}" excluída com sucesso!`}),$()):u({type:"error",message:s.message||"Erro ao excluir conexão."})}catch(s){console.error("Catch no handleConfirmDelete:",s),u({type:"error",message:s.message||"Erro crítico ao excluir conexão."})}finally{S(!1),L(null)}}},V=async s=>{R(s),O(!0),n(null),C(!0);try{console.log(`Iniciando diagnóstico para conexão: ${s.nome} (ID: ${s.id})`);const d=await K(s.id);console.log("Resultado do diagnóstico:",d),n(d)}catch(d){console.error("Exceção ao executar diagnóstico:",d),u({type:"error",message:`Erro ao diagnosticar conexão: ${d.message}`}),C(!1)}finally{O(!1)}},T=()=>{C(!1),n(null),R(null)};return g?e.jsx(M,{message:"Carregando conexões..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Conexões ODBC"}),e.jsx(v,{variant:"success",onClick:()=>B(),children:"Adicionar Nova Conexão"})]}),j&&e.jsx(F,{type:"error",message:j,onClose:()=>c(null)}),m&&e.jsx(F,{type:m.type,message:m.message,onClose:()=>u(null),autoClose:m.type==="success"}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nome"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Host"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Banco"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Usuário"}),e.jsx("th",{scope:"col",className:"relative px-6 py-3",children:e.jsx("span",{className:"sr-only",children:"Ações"})})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[l.length===0&&!g&&e.jsx("tr",{children:e.jsx("td",{colSpan:"5",className:"px-6 py-4 text-center text-sm text-gray-500",children:"Nenhuma conexão encontrada."})}),l.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.nome}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:[s.host,s.porta?`:${s.porta}`:""]}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.banco}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.usuario}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3",children:[e.jsx(v,{variant:"secondary",size:"sm",onClick:()=>B(s),children:"Editar"}),e.jsx(v,{variant:"danger",size:"sm",onClick:()=>q(s),children:"Excluir"}),e.jsx(v,{variant:"info",size:"sm",onClick:()=>V(s),disabled:g||k,title:"Diagnosticar Conexão",children:e.jsx(ne,{})})]})]},s.id))]})]})}),e.jsxs(Q,{isOpen:N,onClose:I,title:t?"Editar Conexão":"Adicionar Nova Conexão",size:"lg",preventClose:b,showFooter:!1,children:[w&&e.jsx(F,{type:"error",message:w,onClose:()=>p(null)}),e.jsx(te,{connection:t,onSave:U,onCancel:I})]}),e.jsxs(Q,{isOpen:f,onClose:T,title:`Diagnóstico: ${(D==null?void 0:D.nome)||"Conexão"}`,size:"lg",children:[k?e.jsx("div",{className:"p-8 text-center",children:e.jsx(M,{message:"Realizando diagnóstico da conexão..."})}):e.jsx(oe,{results:i,connection:D}),e.jsx("div",{className:"flex justify-end mt-4",children:e.jsx(v,{variant:"primary",onClick:T,children:"Fechar"})})]}),e.jsx(J,{isOpen:A,title:"Confirmar Exclusão",message:`Tem certeza que deseja excluir a conexão "${y==null?void 0:y.nome}"? Esta ação não pode ser desfeita.`,confirmLabel:"Excluir",cancelLabel:"Cancelar",onConfirm:H,onCancel:()=>S(!1),variant:"danger"})]})};export{de as default};

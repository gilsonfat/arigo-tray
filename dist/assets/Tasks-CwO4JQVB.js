import{r as o,j as e,a as P}from"./index-JjGluSb1.js";import{f as F,A as $,l as H,m as z,B as C,M as q,C as Q,n as R,o as B,p as J,q as U}from"./ConfirmDialog-CWlH6QHb.js";const V=()=>e.jsxs("div",{className:"text-xs text-gray-500 mt-1 bg-gray-50 p-2 rounded border",children:["Formato Cron: Minuto Hora DiaMês Mês DiaSemana ",e.jsx("br",{}),"(* = qualquer valor, */5 = a cada 5) ",e.jsx("br",{}),"Ex: ",e.jsx("code",{children:"0 9 * * 1-5"})," (9h de Seg a Sex) | ",e.jsx("code",{children:"*/15 * * * *"})," (A cada 15 min) ",e.jsx("br",{}),e.jsx("a",{href:"https://crontab.guru/",target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline",children:"Testar expressão Cron"})]}),W=({task:j,onSave:M,onCancel:O})=>{const[r,y]=o.useState({nome:"",descricao:"",cron:"",consulta_id:"",api_url:"",api_metodo:"POST",api_headers:"{}",ativo:!0,...j||{}}),[g,w]=o.useState([]),[_,l]=o.useState(!0),[h,i]=o.useState(""),[b,S]=o.useState(!0),[x,E]=o.useState(null),v=o.useCallback(async()=>{var n;l(!0);try{const t=await F();t.success?(w(t.data||[]),!j&&((n=t.data)==null?void 0:n.length)>0&&!r.consulta_id&&y(a=>({...a,consulta_id:t.data[0].id}))):(i(`Erro ao carregar consultas: ${t.message}`),w([]))}catch(t){i(`Erro crítico ao carregar consultas: ${t.message}`)}finally{l(!1)}},[j,r.consulta_id]);o.useEffect(()=>{v()},[v]),o.useEffect(()=>{(async()=>{if(!r.consulta_id){E(null);return}const t=parseInt(r.consulta_id,10);try{console.log(`Buscando detalhes da consulta ID: ${t}`);const a=await H(t);a.success?(console.log("Detalhes da consulta obtidos:",a.data),E(a.data),a.data.transform_type==="terceiros"&&!r.api_url&&y(d=>({...d,api_url:"http://localhost:3000/terceiros",api_headers:`{
  "Content-Type": "application/json; charset=utf-8"
}`}))):console.error(`Erro ao buscar consulta: ${a.message}`)}catch(a){console.error("Erro ao buscar detalhes da consulta:",a)}})()},[r.consulta_id]),o.useEffect(()=>{try{JSON.parse(r.api_headers||"{}"),S(!0),h==="O formato dos Headers (JSON) é inválido."&&i("")}catch{S(!1)}},[r.api_headers,h]);const m=n=>{const{name:t,value:a,type:d,checked:p}=n.target;y(f=>({...f,[t]:d==="checkbox"?p:a})),h&&h!=="O formato dos Headers (JSON) é inválido."&&i("")},T=n=>{var k,L,A,I;n.preventDefault(),console.log("Submetendo formulário de tarefa:",r);const t=((k=r.nome)==null?void 0:k.trim())||"",a=((L=r.cron)==null?void 0:L.trim())||"",d=r.consulta_id?parseInt(r.consulta_id,10):null,p=((A=r.api_url)==null?void 0:A.trim())||"";if(console.log("Valores validados:",{nome:t,cron:a,consulta_id:d,api_url:p}),!t||!a||!d||!p){const s=[];t||s.push("Nome"),a||s.push("Cron"),d||s.push("Consulta"),p||s.push("URL da API");const c=`Preencha todos os campos obrigatórios: ${s.join(", ")}`;console.error("Erro de validação:",c),i(c);return}if(!b){i("O formato dos Headers (JSON) é inválido.");return}const f={...r,nome:t,descricao:((I=r.descricao)==null?void 0:I.trim())||"",cron:a,consulta_id:d,api_url:p,api_metodo:r.api_metodo||"POST",api_headers:r.api_headers||"{}"};console.log("Dados formatados para envio:",f);try{M(f)}catch(s){console.error("Erro ao salvar tarefa:",s),i(`Erro ao salvar tarefa: ${s.message}`)}},N=(n,t,a=!1,d="text",p="")=>e.jsxs("div",{children:[e.jsxs("label",{htmlFor:n,className:"block text-sm font-medium text-gray-700 mb-1",children:[t,a&&e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:d,id:n,name:n,value:r[n],onChange:m,required:a,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:p})]});return e.jsxs("form",{id:"modal-form",onSubmit:T,className:"space-y-4",children:[h&&e.jsx($,{type:"error",message:h,onClose:()=>i("")}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[N("nome","Nome da Tarefa",!0,"text","Ex: Enviar Vendas Diárias"),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"ativo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Status"}),e.jsxs("label",{className:"inline-flex items-center cursor-pointer mt-2",children:[e.jsx("input",{type:"checkbox",id:"ativo",name:"ativo",checked:r.ativo,onChange:m,className:"sr-only peer"}),e.jsx("div",{className:"relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"}),e.jsx("span",{className:"ms-3 text-sm font-medium text-gray-900",children:r.ativo?"Ativa":"Inativa"})]})]})]}),N("descricao","Descrição",!1,"text","Envia dados consolidados para API Xpto"),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"cron",className:"block text-sm font-medium text-gray-700 mb-1",children:["Frequência (Expressão Cron)",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",id:"cron",name:"cron",value:r.cron,onChange:m,required:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",placeholder:"0 9 * * 1-5"}),e.jsx(V,{})]}),e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"consulta_id",className:"block text-sm font-medium text-gray-700 mb-1",children:["Consulta SQL a ser executada",e.jsx("span",{className:"text-red-500",children:"*"})]}),_?e.jsx(P,{size:"sm",message:"Carregando consultas..."}):e.jsxs(e.Fragment,{children:[e.jsxs("select",{id:"consulta_id",name:"consulta_id",value:r.consulta_id,onChange:m,required:!0,disabled:g.length===0,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 disabled:bg-gray-100",children:[e.jsx("option",{value:"",disabled:!0,children:g.length===0?"Nenhuma consulta SQL encontrada":"-- Selecione a Consulta --"}),g.map(n=>e.jsx("option",{value:n.id,children:n.nome},n.id))]}),(x==null?void 0:x.transform_type)&&e.jsx("div",{className:"mt-2 p-2 bg-blue-50 rounded border border-blue-200",children:e.jsxs("p",{className:"text-sm text-blue-700",children:[e.jsx("span",{className:"font-medium",children:"Transformação de dados:"})," ",x.transform_type,x.transform_type==="terceiros"&&e.jsx("span",{className:"block mt-1 text-xs",children:"Esta consulta será transformada para o formato padrão de terceiros antes do envio."})]})})]})]}),e.jsx("h3",{className:"text-lg font-medium text-gray-800 pt-4 border-t mt-6",children:"Destino da API"}),N("api_url","URL da API",!0,"url","https://api.exemplo.com/dados"),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:e.jsxs("div",{children:[e.jsx("label",{htmlFor:"api_metodo",className:"block text-sm font-medium text-gray-700 mb-1",children:"Método HTTP"}),e.jsxs("select",{id:"api_metodo",name:"api_metodo",value:r.api_metodo,onChange:m,className:"w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500",children:[e.jsx("option",{value:"POST",children:"POST"}),e.jsx("option",{value:"PUT",children:"PUT"}),e.jsx("option",{value:"PATCH",children:"PATCH"})]})]})}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"api_headers",className:"block text-sm font-medium text-gray-700 mb-1",children:"Headers da Requisição (JSON)"}),e.jsx("textarea",{id:"api_headers",name:"api_headers",rows:"3",value:r.api_headers,onChange:m,className:`w-full px-3 py-2 border rounded-md shadow-sm font-mono text-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 ${b?"border-gray-300":"border-red-500 focus:ring-red-500"}`,placeholder:'{ "Content-Type": "application/json", "Authorization": "Bearer SEU_TOKEN" }'}),!b&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Formato JSON inválido."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Insira os cabeçalhos HTTP como um objeto JSON válido."})]})]})},K=()=>e.jsxs("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})]}),X=()=>e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"})}),G=()=>e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})}),ee=()=>{const[j,M]=o.useState([]),[O,r]=o.useState(!0),[y,g]=o.useState(null),[w,_]=o.useState(!1),[l,h]=o.useState(null),[i,b]=o.useState(!1),[S,x]=o.useState(null),[E,v]=o.useState(!1),[m,T]=o.useState(null),[N,n]=o.useState(null),[t,a]=o.useState(null),d=o.useCallback(async()=>{r(!0),g(null),a(null);try{const s=await z();if(s.success){const c=(s.data||[]).sort((u,D)=>u.nome.localeCompare(D.nome));M(c)}else g(s.message||"Erro desconhecido ao buscar tarefas.")}catch(s){console.error("Catch no fetchTasks:",s),g(s.message||"Erro crítico ao buscar tarefas.")}finally{r(!1)}},[]);o.useEffect(()=>{d()},[d]);const p=(s=null)=>{h(s),x(null),_(!0)},f=()=>{i||(_(!1),h(null),x(null))},k=async s=>{b(!0),x(null),a(null);try{console.log("Salvando tarefa com dados:",s);let c;const u={...s,ativo:s.ativo?1:0,consulta_id:s.consulta_id?parseInt(s.consulta_id,10):null};console.log("Dados formatados para envio:",u),l!=null&&l.id?(console.log(`Atualizando tarefa ID ${l.id}:`,u),c=await B(l.id,u)):(console.log("Criando nova tarefa:",u),c=await J(u)),console.log("Resposta do servidor:",c),c.success?(f(),d(),a({type:"success",message:`Tarefa "${s.nome}" ${l!=null&&l.id?"atualizada":"criada"} com sucesso!`})):(console.error("Erro retornado pelo servidor:",c.message),x(c.message||`Falha ao ${l!=null&&l.id?"atualizar":"criar"} tarefa.`))}catch(c){console.error("Catch no handleSaveTask:",c),x(c.message||"Erro crítico ao salvar tarefa.")}finally{b(!1)}},L=s=>{T(s),v(!0)},A=async()=>{if(m){a(null);try{const s=await U(m.id);s.success?(a({type:"success",message:`Tarefa "${m.nome}" excluída com sucesso!`}),d()):a({type:"error",message:s.message||"Erro ao excluir tarefa."})}catch(s){console.error("Catch no handleConfirmDelete:",s),a({type:"error",message:s.message||"Erro crítico ao excluir tarefa."})}finally{v(!1),T(null)}}},I=async(s,c)=>{n(s),a(null);try{const u=await R(s);u.success?a({type:"success",message:`Tarefa "${c}" executada manualmente com sucesso! ${u.message||""}`.trim()}):a({type:"error",message:`Falha ao executar tarefa "${c}": ${u.message||"Erro desconhecido"}`})}catch(u){console.error("Catch no handleExecuteTask:",u),a({type:"error",message:`Erro crítico ao executar tarefa "${c}": ${u.message}`})}finally{n(null)}};return O?e.jsx(P,{message:"Carregando tarefas agendadas..."}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-800",children:"Tarefas Agendadas"}),e.jsx(C,{variant:"success",onClick:()=>p(),children:"Adicionar Nova Tarefa"})]}),y&&e.jsx($,{type:"error",message:y,onClose:()=>g(null)}),t&&e.jsx($,{type:t.type,message:t.message,onClose:()=>a(null),autoClose:t.type==="success"}),e.jsx("div",{className:"bg-white shadow overflow-hidden sm:rounded-lg",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Status"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Nome"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Cron"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Consulta"}),e.jsx("th",{scope:"col",className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"API URL"}),e.jsx("th",{scope:"col",className:"relative px-6 py-3",children:e.jsx("span",{className:"sr-only",children:"Ações"})})]})}),e.jsxs("tbody",{className:"bg-white divide-y divide-gray-200",children:[j.length===0&&!O&&e.jsx("tr",{children:e.jsx("td",{colSpan:"6",className:"px-6 py-4 text-center text-sm text-gray-500",children:"Nenhuma tarefa agendada encontrada."})}),j.map(s=>e.jsxs("tr",{className:s.ativo?"":"bg-gray-50 opacity-70",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm",children:e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${s.ativo?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:[e.jsx("span",{className:`w-2 h-2 mr-1.5 rounded-full ${s.ativo?"bg-green-500":"bg-red-500"}`}),s.ativo?"Ativa":"Inativa"]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900",children:s.nome}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono",children:s.cron}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500",children:s.nome_consulta||"N/A"})," ",e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm text-gray-500 max-w-xs truncate",title:s.api_url,children:s.api_url}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2",children:[e.jsx(C,{variant:"info",size:"sm",onClick:()=>I(s.id,s.nome),isLoading:N===s.id,disabled:N===s.id||!s.ativo,title:"Executar Tarefa Agora",className:"px-2 py-1",children:e.jsx(K,{})}),e.jsx(C,{variant:"secondary",size:"sm",onClick:()=>p(s),title:"Editar Tarefa",className:"px-2 py-1",children:e.jsx(X,{})}),e.jsx(C,{variant:"danger",size:"sm",onClick:()=>L(s),title:"Excluir Tarefa",className:"px-2 py-1",children:e.jsx(G,{})})]})]},s.id))]})]})}),e.jsxs(q,{isOpen:w,onClose:f,title:l?"Editar Tarefa Agendada":"Adicionar Nova Tarefa",size:"lg",preventClose:i,footerContent:e.jsxs("div",{className:"flex justify-end space-x-3",children:[e.jsx(C,{variant:"secondary",onClick:f,disabled:i,children:"Cancelar"}),e.jsx(C,{type:"submit",form:"modal-form",variant:"primary",isLoading:i,disabled:i,children:i?"Salvando...":"Salvar Tarefa"})]}),children:[S&&e.jsx($,{type:"error",message:S,onClose:()=>x(null)}),w&&e.jsx(W,{task:l,onSave:k,onCancel:f},(l==null?void 0:l.id)||"new-task")]}),e.jsx(Q,{isOpen:E,title:"Confirmar Exclusão",message:e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:['Tem certeza que deseja excluir a tarefa "',e.jsx("strong",{children:m==null?void 0:m.nome}),'"?']}),e.jsx("p",{className:"text-sm text-red-600 mt-2",children:"Isso removerá o agendamento. Esta ação não pode ser desfeita."})]}),confirmLabel:"Excluir",cancelLabel:"Cancelar",onConfirm:A,onCancel:()=>v(!1),variant:"danger"})]})};export{ee as default};
